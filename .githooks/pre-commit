#!/bin/bash

# Axionyx Pre-commit Hook
# Runs linting and checks for modified components

set -e

echo "üîç Running pre-commit checks..."

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Flags to track which components changed
BACKEND_CHANGED=false
FRONTEND_CHANGED=false
MOBILE_CHANGED=false

# Check which components have changes
echo "$CHANGED_FILES" | grep -q "^backend/" && BACKEND_CHANGED=true
echo "$CHANGED_FILES" | grep -q "^frontend/" && FRONTEND_CHANGED=true
echo "$CHANGED_FILES" | grep -q "^mobile/" && MOBILE_CHANGED=true

# Backend checks (Python)
if [ "$BACKEND_CHANGED" = true ]; then
    echo "üì¶ Backend files changed - running Python checks..."
    cd backend

    if command -v uv &> /dev/null; then
        echo "  ‚Üí Running ruff lint..."
        uv run ruff check . --fix || {
            echo "‚ùå Ruff linting failed!"
            exit 1
        }

        echo "  ‚Üí Running ruff format..."
        uv run ruff format . || {
            echo "‚ùå Ruff formatting failed!"
            exit 1
        }
    else
        echo "‚ö†Ô∏è  uv not found, skipping Python checks"
    fi

    cd ..
    echo "‚úÖ Backend checks passed"
fi

# Frontend checks (TypeScript/Next.js)
if [ "$FRONTEND_CHANGED" = true ]; then
    echo "‚öõÔ∏è  Frontend files changed - running TypeScript checks..."
    cd frontend

    if [ -d "node_modules" ]; then
        echo "  ‚Üí Running ESLint..."
        npm run lint || {
            echo "‚ùå ESLint failed!"
            exit 1
        }

        echo "  ‚Üí Running type check..."
        npm run typecheck || {
            echo "‚ùå Type check failed!"
            exit 1
        }
    else
        echo "‚ö†Ô∏è  node_modules not found, run 'npm install' first"
        exit 1
    fi

    cd ..
    echo "‚úÖ Frontend checks passed"
fi

# Mobile checks (Flutter/Dart)
if [ "$MOBILE_CHANGED" = true ]; then
    echo "üì± Mobile files changed - running Dart checks..."
    cd mobile

    if command -v flutter &> /dev/null; then
        echo "  ‚Üí Running dart format..."
        dart format lib/ --set-exit-if-changed || {
            echo "‚ùå Dart formatting failed! Run 'dart format lib/' to fix"
            exit 1
        }

        echo "  ‚Üí Running flutter analyze..."
        flutter analyze || {
            echo "‚ùå Flutter analyze failed!"
            exit 1
        }
    else
        echo "‚ö†Ô∏è  Flutter not found, skipping mobile checks"
    fi

    cd ..
    echo "‚úÖ Mobile checks passed"
fi

# General checks for all files
echo "üîß Running general checks..."

# Check for trailing whitespace
if echo "$CHANGED_FILES" | xargs grep -l '[[:space:]]$' 2>/dev/null; then
    echo "‚ö†Ô∏è  Warning: Files have trailing whitespace"
fi

# Check for TODO/FIXME comments being added
if echo "$CHANGED_FILES" | xargs grep -l 'TODO\|FIXME' 2>/dev/null; then
    echo "‚ÑπÔ∏è  Info: Files contain TODO/FIXME comments"
fi

echo ""
echo "‚ú® All pre-commit checks passed!"
exit 0
