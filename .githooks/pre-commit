#!/bin/bash

# Axionyx Pre-commit Hook
# Runs linting and checks for modified components

set -e

echo "üîç Running pre-commit checks..."

# Get the git root directory
GIT_ROOT=$(git rev-parse --show-toplevel)
cd "$GIT_ROOT"

# Get list of changed files (exclude .githooks and .git directories)
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -v '^\.githooks/' | grep -v '^\.git/' || true)

# If only .githooks files are being committed, skip all checks
if [ -z "$CHANGED_FILES" ]; then
    echo "‚ÑπÔ∏è  Only .githooks files changed, skipping component checks..."
    echo "‚ú® Pre-commit checks passed!"
    exit 0
fi

# Flags to track which components changed
BACKEND_CHANGED=false
FRONTEND_CHANGED=false
MOBILE_CHANGED=false

# Check which components have changes
echo "$CHANGED_FILES" | grep -q "^backend/" && BACKEND_CHANGED=true || true
echo "$CHANGED_FILES" | grep -q "^frontend/" && FRONTEND_CHANGED=true || true
echo "$CHANGED_FILES" | grep -q "^mobile/" && MOBILE_CHANGED=true || true

# Backend checks (Python)
if [ "$BACKEND_CHANGED" = true ]; then
    echo "üì¶ Backend files changed - running Python checks..."

    if command -v uv &> /dev/null; then
        echo "  ‚Üí Running ruff lint..."
        (cd "$GIT_ROOT/backend" && uv run ruff check . --fix) || {
            echo "‚ùå Ruff linting failed!"
            exit 1
        }

        echo "  ‚Üí Running ruff format..."
        (cd "$GIT_ROOT/backend" && uv run ruff format .) || {
            echo "‚ùå Ruff formatting failed!"
            exit 1
        }
    else
        echo "‚ö†Ô∏è  uv not found, skipping Python checks"
    fi

    echo "‚úÖ Backend checks passed"
fi

# Frontend checks (TypeScript/Next.js)
if [ "$FRONTEND_CHANGED" = true ]; then
    echo "‚öõÔ∏è  Frontend files changed - running TypeScript checks..."

    if [ -d "$GIT_ROOT/frontend/node_modules" ]; then
        echo "  ‚Üí Running ESLint..."
        (cd "$GIT_ROOT/frontend" && npm run lint) || {
            echo "‚ùå ESLint failed!"
            exit 1
        }

        echo "  ‚Üí Running type check..."
        (cd "$GIT_ROOT/frontend" && npm run typecheck) || {
            echo "‚ùå Type check failed!"
            exit 1
        }
    else
        echo "‚ö†Ô∏è  node_modules not found, run 'npm install' in frontend/ first"
        exit 1
    fi

    echo "‚úÖ Frontend checks passed"
fi

# Mobile checks (Flutter/Dart)
if [ "$MOBILE_CHANGED" = true ]; then
    echo "üì± Mobile files changed - running Dart checks..."

    if command -v flutter &> /dev/null; then
        echo "  ‚Üí Running dart format..."
        (cd "$GIT_ROOT/mobile" && dart format lib/ --set-exit-if-changed) || {
            echo "‚ùå Dart formatting failed! Run 'cd mobile && dart format lib/' to fix"
            exit 1
        }

        echo "  ‚Üí Running flutter analyze..."
        (cd "$GIT_ROOT/mobile" && flutter analyze) || {
            echo "‚ùå Flutter analyze failed!"
            exit 1
        }
    else
        echo "‚ö†Ô∏è  Flutter not found, skipping mobile checks"
    fi

    echo "‚úÖ Mobile checks passed"
fi

# General checks for all files
echo "üîß Running general checks..."

# Check for API keys, secrets, and credentials
echo "  ‚Üí Checking for API keys and secrets..."
if echo "$CHANGED_FILES" | xargs grep -nE '(API_KEY|SECRET_KEY|PASSWORD|TOKEN|PRIVATE_KEY|api_key|secret_key|password|token|private_key)\s*[:=]\s*["\047][^"\047]{8,}["\047]' 2>/dev/null; then
    echo "‚ùå ERROR: Potential API keys or secrets detected!"
    echo "Please remove sensitive data before committing."
    exit 1
fi

# Check for AWS keys
if echo "$CHANGED_FILES" | xargs grep -nE 'AKIA[0-9A-Z]{16}' 2>/dev/null; then
    echo "‚ùå ERROR: AWS Access Key detected!"
    exit 1
fi

# Check for private key files
if echo "$CHANGED_FILES" | xargs grep -l 'BEGIN.*PRIVATE KEY' 2>/dev/null; then
    echo "‚ùå ERROR: Private key content detected!"
    exit 1
fi

# Check for Bearer tokens
if echo "$CHANGED_FILES" | xargs grep -nE 'Bearer\s+[A-Za-z0-9\-\._~\+\/]+=*' 2>/dev/null; then
    echo "‚ùå ERROR: Bearer token detected!"
    exit 1
fi

# Check for trailing whitespace
if echo "$CHANGED_FILES" | xargs grep -l '[[:space:]]$' 2>/dev/null; then
    echo "‚ö†Ô∏è  Warning: Files have trailing whitespace"
fi

# Check for TODO/FIXME comments being added
if echo "$CHANGED_FILES" | xargs grep -l 'TODO\|FIXME' 2>/dev/null; then
    echo "‚ÑπÔ∏è  Info: Files contain TODO/FIXME comments"
fi

echo ""
echo "‚ú® All pre-commit checks passed!"
exit 0
