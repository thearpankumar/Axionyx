name: Firmware CI

on:
  push:
    branches: [master, main, develop]
    paths:
      - 'firmware/**'
      - '.github/workflows/firmware-ci.yml'
  pull_request:
    branches: [master, main, develop]
    paths:
      - 'firmware/**'
      - '.github/workflows/firmware-ci.yml'

jobs:
  discover-projects:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.find-projects.outputs.projects }}
    steps:
    - uses: actions/checkout@v4

    - name: Find PlatformIO projects
      id: find-projects
      run: |
        # Find all platformio.ini files, excluding .pio build directories
        projects=$(find firmware -name "platformio.ini" -type f | grep -v ".pio" | jq -R -s -c 'split("\n")[:-1]')
        echo "Found projects:"
        echo "$projects" | jq -r '.[]'
        echo "projects=$projects" >> $GITHUB_OUTPUT

  compile:
    runs-on: ubuntu-latest
    needs: discover-projects
    if: ${{ needs.discover-projects.outputs.projects != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover-projects.outputs.projects) }}

    steps:
    - uses: actions/checkout@v4

    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio

    - name: Get project directory
      id: project-dir
      run: |
        project_path="${{ matrix.project }}"
        project_dir=$(dirname "$project_path")
        project_name=$(basename "$project_dir")
        echo "dir=$project_dir" >> $GITHUB_OUTPUT
        echo "name=$project_name" >> $GITHUB_OUTPUT
        echo "Building project: $project_name"
        echo "Project directory: $project_dir"

    - name: Build firmware
      run: |
        cd "${{ steps.project-dir.outputs.dir }}"
        echo "Building in $(pwd)"
        pio run
